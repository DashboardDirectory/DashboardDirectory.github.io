<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Adobe Workfront - Stopwatch OAuth2</title>
  <link rel="stylesheet" type="text/css" href="core/css/metro-bootstrap.min.css">
  <link rel="shortcut icon" type="image/png" href="icons/timer32x32.png">
  <script type="text/javascript" src="core/docs/jquery-1.8.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
  <script>
      // setup local storage for oath
      const setCookie = (cname, cvalue, exdays) => {
          let cookie_prefix =  localStorage.getItem("cookie_prefix");
          localStorage.setItem(cookie_prefix + '_oauth_'+cname, cvalue);
      };
      const getCookie = (cname) => {
          let cookie_prefix =  localStorage.getItem("cookie_prefix");
          return localStorage.getItem(cookie_prefix + '_oauth_'+cname);
      };
      const deleteCookie = (cname, path, domain) => {
          let cookie_prefix =  localStorage.getItem("cookie_prefix");
          if (getCookie(cname)) {
              localStorage.removeItem(cookie_prefix + '_oauth_'+cname);
          }
      };
      const encrypt = (text, key) => CryptoJS.AES.encrypt(text, key).toString();
      const decrypt = (cipherText, key) => {
          return (CryptoJS.AES.decrypt(cipherText, key)).toString(CryptoJS.enc.Utf8);
      };
      // sav initial values to pass to stopwatch
      var params = new URLSearchParams(document.location.search);
      var host = params.get("h");
      if (host) {
          localStorage.setItem("cookie_prefix", host);
          setCookie('host', host);
      }
      var userID = params.get("u");
      if (userID) {
          setCookie('userID', userID);
      }
      var taskid = params.get("taskid");
      if (taskid) {
          setCookie('taskid', taskid);
      }

    function launch(sessionID) {
      if (!sessionID) {
        const encrypted_access_token = getCookie("encrypted_access_token");
        if (encrypted_access_token)
          sessionID = decrypt(encrypted_access_token, ACCESS_TOKEN_KEY);
        else {
         // updatePageState();

          return;
        }
      }
      console.log('session: ' + sessionID);

      userID = getCookie('userID');
      host = getCookie('host');
      taskid = getCookie('taskid');

      let url = 'launch.html?taskid=' + taskid + "&u=" + userID + "&d=" + host + "&sid=" + sessionID;
      if (window.swpop && window.swpop.opener) {
        window.swpop.location.href = url;
        window.swpop.focus();
      } else {
        window.swpop = window.open(url, 'swpop'
          , 'height=600,width=500,left=100,top=100,resizable=yes,scrollbars=no,toolbar=no,menubar=no,location=no,directories=no,status=no'
        );
      }
    }
  </script>
  <script type="text/javascript" src="oauth.js.test"></script>
  <script>
      const REFRESH_TOKEN_KEY = "REFRESH_TOKEN_KEY";
      const ACCESS_TOKEN_KEY = "ACCESS_TOKEN_KEY";
      const CODE_KEY = "CODE_KEY";
      const DOMAIN_KEY = "DOMAIN_KEY";
      const LANE_KEY = "LANE_KEY";
      const tokenEndpoint = "integrations/oauth2/api/v1/token";
      const revokeEndpoint = "integrations/oauth2/api/v1/revoke";

     /* const getUrl = () => {
          const url = new URL(window.location.href);
          url.search = '';
          url.hash = '';

          return url.href;
      };*/

      const setCookie = (cname, cvalue, exdays) => {
          localStorage.setItem('_oauth_'+cname, cvalue);
      };
      const getCookie = (cname) => {
          return localStorage.getItem('_oauth_'+cname);
      };
      const deleteCookie = (cname, path, domain) => {
          if (getCookie(cname)) {
              localStorage.removeItem('_oauth_'+cname);
          }
      };

      const encrypt = (text, key) => CryptoJS.AES.encrypt(text, key).toString();
      const decrypt = (cipherText, key) => {
          return (CryptoJS.AES.decrypt(cipherText, key)).toString(CryptoJS.enc.Utf8);
      };

      const getParams = () => {
          const args = new URLSearchParams(location.search);
          const code = args.get("code");
          const domain = args.get("domain");
          const lane = args.get("lane");

          return { code, domain, lane };
      };

      const setParamsCookie = ({ code, domain, lane }) => {
          setCookie("encrypted_code", encrypt(code, CODE_KEY));
          setCookie("encrypted_domain", encrypt(domain, DOMAIN_KEY));
          setCookie("encrypted_lane", encrypt(lane, LANE_KEY));
          setCookie("code", code);
          setCookie("domain", domain);
          setCookie("lane", lane);
      };

      async function getToken() {
          console.log('get token');
          const { code, domain, lane } = getParamsCookie();
          try {
              fetch(
            `https://${domain}.${lane}.workfront.com/${tokenEndpoint}`,
              {
                  method: "POST",
                          headers: { "Content-Type": "application/json;charset=utf-8", },
                  body: JSON.stringify({
                      client_id: clientId,
                      code_verifier: localStorage.getItem("code_verifier"),
                      grant_type: "authorization_code",
                      redirect_uri: getUrl(),
                      code: code,
                  }),
              }).then(response => {
                  if (response.ok) {
                  return response.json();
              } else if (response.status === 400) {
                  console.log('logged in gt2');
              } else if (response.status === 404) {
                  // Handle 404 Not Found
                  throw new Error('Resource not found');
              } else {
                  // Handle other status codes
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
          }).then(data => {
              console.log('getting token ' + data.access_token);

          setCookie("access_token", data.access_token);
          setCookie("refresh_token", data.refresh_token);
          setCookie("encrypted_access_token", encrypt(data.access_token, ACCESS_TOKEN_KEY));
          setCookie("encrypted_refresh_token", encrypt(data.refresh_token, REFRESH_TOKEN_KEY));

          // Send the token back to the opener window (the main page)
          window.opener.postMessage({ token: data.access_token }, '*');
          setTimeout(() => {
              window.close();
      }, 100);
      }).catch(error => {
          console.error('Fetch error:', error);
      });
      } catch (error) {
          console.log(error);
      }
      }


  </script>

  <script>
        /*const getUrl = () => {
            const url = new URL(window.location.href);
            url.search = '';
            url.hash = '';

            return url.href;
        };*/
        const dec2hex = (dec) => {
            return ("0" + dec.toString(16)).substr(-2);
        };
        const sha256 = (plain) => {
            return crypto.subtle.digest("SHA-256", (new TextEncoder()).encode(plain));
        };
        const base64urlencode = (a) => {
            let str = "";
            const bytes = new Uint8Array(a);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                str += String.fromCharCode(bytes[i]);
            }

            return btoa(str)
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+$/, "");
        };
        const generateRandomString = () => {
            const array = new Uint32Array(56 / 2);
            crypto.getRandomValues(array);

            return Array.from(array, dec2hex).join("");
        };
        const generateCodeChallenge = async (v) => {
            hashed = await sha256(v);

            return base64urlencode(hashed);
        };
        async function openOAuthWindow(clientId) {
            const authorizeEndpoint = "https://oauth.my.workfront.com/integrations/oauth2/authorize";
            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            localStorage.setItem("code_verifier", codeVerifier);
            let fullUrl = getUrl();
            let directoryPath = fullUrl.substring(0, fullUrl.lastIndexOf('/') + 1);

            const args = new URLSearchParams({
                response_type: "code",
                client_id: clientId,
                code_challenge_method: "S256",
                code_challenge: codeChallenge,
                redirect_uri: getUrl(),//directoryPath + 'oauth_set.html',
                search: location.search
            });
            const oauthWindow = window.open(authorizeEndpoint + "?" + args, 'OAuthWindow', 'width=600,height=740');
            window.addEventListener('message', function(event) {
                if (event.origin !== 'https://oauth.my.workfront.com') {
                    return;
                }

                if (event.data && event.data.token) {
                    oauthWindow.close();
                    localStorage.setItem('session_token', event.data.token);
                    //document.postMessage({ token: event.data.token }, '*');
                    launch(event.data.token);
                }
            });
        }

        if (location.search) {
            const { code, domain, lane } = getParams();
            if (code) { // && !getCookie("encrypted_access_token")
                setParamsCookie({ code, domain, lane })
                getToken();
            } else {
                let clientId = params.get("cid");
                if (clientId != null) {
                    localStorage.setItem("clientId", clientId);
                } else {
                    clientId = localStorage.getItem("clientId");
                    console.log('clear login');
                }

                if (!localStorage.getItem('session_token')) {
                    openOAuthWindow(clientId);
                }
            }
        }
    </script>
  <style>
    .instr {
      display: none;
    }

    #error {
      color: red;
      width: 100%;
      height: 20px;
      background-color: pink;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div>
    <div style="width: 550px; max-width: 550px; margin-left:auto; margin-right:auto;">
      <div class="well-large chrome instr" style="text-align:center;"></div>
      <div class="well-large ie6 instr">
        <h2>Sorry, This browser is not supported.</h2>
      </div>
      <div class="well-large" id="message" style="text-align: center">
         <img src="/stopwatch/icons/timer128x128.png">
        <h1 style="color:#2e63cc;">Stopwatch Launched!</h1>
        <div class="well-small">
          <h3>If you don't see the new window, make sure popup blocker is disabled, or perhaps it is behind this window,
            Then try launching again</h3>

          <p><a class='btn btn-primary bookmark' href="#" title="Launch Stopwatch" onclick="launch();">Launch
              Stopwatch and Start Task</a></p>

          <div class="well-small chrome instr">
            <p>For how to manage pop-up settings in Chrome, have a look at <a
                href="http://www.google.com/support/chrome/bin/answer.py?hl=en&amp;answer=95472"
                title="disable pop-ups in Chrome" target="_blank">Google's support documentation</a>.</p>
          </div>
          <div class="well-small firefox instr">
            <p>Mozilla's support pages show you how to <a href="http://support.mozilla.com/en-US/kb/Pop-up+blocker"
                title="disable pop-ups in Firefox" rel="external" target="_blank">manage pop-up blocker settings in
                Firefox</a>.</p>
          </div>
          <div class="well-small ie instr">
            <p><a
                href="http://windows.microsoft.com/en-us/Windows-vista/Internet-Explorer-Pop-up-Blocker-frequently-asked-questions"
                rel="external" title="pop ups in IE" target="_blank">Microsoft's FAQ</a> shows you how to turn
              Internet Explorer's pop-up blocker on and off.</p>
          </div>
          <div class="well-small safari instr">
            <p>Safari's pop-up blocker doesn't block pop-ups from opening if you've
              clicked on a button, so please <a class='btn btn-primary bookmark' href="#" title="Launch Stopwatch"
                onclick="launch();">launch stopwatch manually.</a></p>
          </div>
            <p><a class='btn btn-secondary bookmark' href="#" title="Refresh Access" onclick="refreshToken();">
                Refresh access and relaunch</a></p>
        </div>
      </div>
    </div>
    <div id="error"></div>
    <div style="display: none" id="notAuthenticated">
      <button id="startButton">Login</button>
    </div>
    <div id="authenticated" style="display: none">
      Your access_token (sessionID) is <span id="accessToken"></span>
      <br />
      <button id="refresh" onclick="refreshToken()">
        Refresh token (sessionID)
      </button>
      <button id="logout" onclick="logout()">Log out</button>
    </div>
  </div>
  <script>
    let ua = navigator.userAgent;
    let msie = ua.indexOf("MSIE ");
    if ((typeof window.sidebar == "object") && (typeof window.sidebar.addPanel == "function")) {
      // Gecko
      jQuery('.firefox').show();
    } else if (msie > 0 && typeof window.external == "object") {
      if (9 > parseInt(ua.substring(msie + 5, ua.indexOf(".", msie)))) {
        // IE 6
        jQuery('#message').hide();
        jQuery('.ie6').show();
      } else {
        jQuery('.ie').show();
      }
    } else if (window.opera) {
      jQuery('.opera').show();
    } else if (window.hasOwnProperty('chrome')) {
      jQuery('.chrome').show();
    } else if (ua.indexOf('Safari') != -1 &&
      ua.indexOf('Chrome') == -1) {
      jQuery('.safari').show();
    }
  </script>
  <script>
    /*updatePageState();

    if (location.search) {
      const { code, domain, lane } = getParams();
      if (code && !getCookie("encrypted_access_token")) {
        setParamsCookie({ code, domain, lane })
        getToken();
      }
    }
    document.getElementById("startButton").onclick = async () => {
      login ? login() : console.log('logged in');
    };*/
  </script>
</body>

</html>